import{M as n,N as l,Z as B,_ as G,aa as u,ba as b,ca as F,ea as $,fa as R}from"./chunk-Q6UHPJXR.js";import{$b as L,E as Z,M as y,N as f,R as p,X as s,c as Y,cc as h,f as Q,ka as q,p as j,sa as r,t as c,u as d}from"./chunk-7TD4AYMG.js";import{c as H}from"./chunk-2VMXMS7J.js";function ae(i){return{id:i.id,name:i.name,raceNumber:i.raceNumber,category:i.category,yourTeam:i.yourTeam,gapChartVisible:i.gapChartVisible,shadowChartVisible:i.shadowChartVisible,pitNowChartVisible:i.pitNowChartVisible}}function K(i){return i.map(e=>ae(e))}var m=class i{destroyRef=s(q);firestore=s(G);destroyed=new Q;notificationService=s(R);constructor(){this.destroyRef.onDestroy(()=>{this.destroyed.next(),this.destroyed.complete()})}updateData(e,t){return $(F(this.collectionRef,e.toString()),t,{merge:!1})}updateDataWithMessage(e,t,o){return H(this,null,function*(){try{yield $(F(this.collectionRef,e.toString()),t,{merge:!1}),this.notificationService.success("Updated: "+o)}catch(a){throw this.notificationService.error("Error updating: "+o),a}})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var D=class i extends m{collectionPath="/team-updates";collectionRef=b(this.firestore,this.collectionPath);teamUpdate=r(void 0);constructor(){super(),this.getTeamUpdate().pipe(n()).subscribe(e=>{if(e){let t=this.teamUpdate();(!t||t.updatedAt<e.updatedAt)&&this.teamUpdate.set(e)}})}getTeamUpdate(){return d({teamUpdates:u(this.collectionRef)}).pipe(f(this.destroyed),c(({teamUpdates:e})=>{let t=e;if(t.length>0)return t.filter(o=>!o.deleted).at(0)}))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var C=class i{path="/team-management";httpClient=s(L);teamUpdateService=s(D);notificationService=s(R);teams=r([]);constructor(){this.getTeams([]).pipe(n()).subscribe(e=>{this.teams.set(this.merge(this.teams(),e))}),l(this.teamUpdateService.teamUpdate).pipe(y(e=>e?this.getTeams(e.updatedIds):[]),n()).subscribe(e=>{this.teams.set(this.merge(this.teams(),e))})}merge(e,t){let o=new Map(e.map(a=>[a.id,a]));return t.forEach(a=>{o.set(a.id,a)}),Array.from(o.values()).sort((a,v)=>a.raceNumber-v.raceNumber)}refreshTeams(){this.getTeams([]).subscribe(e=>{this.teams.set(this.teams()),this.notificationService.success("Teams refreshed")})}getTeams(e){return this.httpClient.post(`${h.baseUrl}${this.path}/teams`,{ids:e}).pipe(c(t=>K(t)))}updateGapChartVisibility(e,t){this.httpClient.post(`${h.baseUrl}${this.path}/teams/${e}/gap-chart-visibility`,{visible:t}).subscribe(()=>this.notificationService.success(`Team ${e} - gap chart visibility updated`))}updatePitNowChartVisibility(e,t){this.httpClient.post(`${h.baseUrl}${this.path}/teams/${e}/pit-now-chart-visibility`,{visible:t}).subscribe(()=>this.notificationService.success(`Team ${e} - pit now chart visibility updated`))}updateShadowChartVisibility(e,t){this.httpClient.post(`${h.baseUrl}${this.path}/teams/${e}/shadow-chart-visibility`,{visible:t}).subscribe(()=>this.notificationService.success(`Team ${e} - shadow chart visibility updated`))}resetChartVisibility(){this.httpClient.get(`${h.baseUrl}${this.path}/teams/reset-chart-visibility`).subscribe(()=>this.notificationService.success("Team chart visibility reset"))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var U=class i{teamDataService=s(C);worker;activeTeam=r(void 0);teamNameByRaceNumber=r(new Map);gapChartVisibleByRaceNumber=r(new Map);shadowChartVisibleByRaceNumber=r(new Map);pitNowChartVisibleByRaceNumber=r(new Map);constructor(){typeof Worker<"u"&&(this.worker=new Worker(new URL("worker-IPNARZWR.js",import.meta.url),{type:"module"}),this.worker.onmessage=({data:e})=>{this.activeTeam.set(e.activeTeam),this.teamNameByRaceNumber.set(e.teamNameByRaceNumber),this.gapChartVisibleByRaceNumber.set(e.gapChartVisibleByRaceNumber),this.shadowChartVisibleByRaceNumber.set(e.shadowChartVisibleByRaceNumber),this.pitNowChartVisibleByRaceNumber.set(e.pitNowChartVisibleByRaceNumber)}),d({teams:l(this.teamDataService.teams)}).pipe(n()).subscribe(({teams:e})=>{this.worker&&this.worker.postMessage({teams:e})})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var w=class i extends m{collectionPath="/lap-configs";collectionRef=b(this.firestore,this.collectionPath);lapConfig=r(void 0);constructor(){super(),this.getAll().pipe(n()).subscribe(e=>{e.length>0&&this.lapConfig.set(e.at(0))})}updateReferenceLapTime(e){let t=this.lapConfig();t&&(t.referenceLapTimeMillisecond=e,this.updateDataWithMessage(t.id,t,"reference lap time"))}updatePaceLapThreshold(e){let t=this.lapConfig();t&&(t.paceLapThresholdMilliseconds=e,this.updateDataWithMessage(t.id,t,"pace lap threshold"))}updatePaceLapNumber(e){let t=this.lapConfig();t&&(t.paceLapNumber=e,this.updateDataWithMessage(t.id,t,"pace lap number"))}getAll(){return u(this.collectionRef).pipe(f(this.destroyed),c(e=>e.map(t=>t).filter(t=>!t.deleted)))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};function oe(i){return{id:i.id,raceId:i.raceId,driverId:i.driverId,stintId:i.stintId,raceNumber:i.raceNumber,lapNumber:i.lapNumber,pitNumber:i.pitNumber,pitStop:i.pitStop,lapMilliseconds:i.lastLapMilliseconds,gap:i.gap,position:i.position}}function T(i){return i.map(e=>oe(e))}function V(i){if(i!=null)return{id:i.id,startedAt:new Date(i.startedAt),endedAt:i.endedAt!=null?new Date(i.endedAt):void 0}}var M=class i extends m{collectionPath="/race-configs";collectionRef=b(this.firestore,this.collectionPath);raceConfig=r(void 0);constructor(){super(),this.getAll().pipe(n()).subscribe(e=>{e.length>0&&this.raceConfig.set(e.at(0))})}updateFuelDurationMinute(e){let t=this.raceConfig();t&&(t.fuelDurationMinute=e,this.updateDataWithMessage(t.id,t,"fuel duration minute"))}updateInterphoneBatteryDurationMinute(e){let t=this.raceConfig();t&&(t.interphoneBatteryDurationMinute=e,this.updateDataWithMessage(t.id,t,"interphone battery duration minute"))}updateStartRaceDriverId(e){let t=this.raceConfig();t&&(t.startRaceDriverId=e,this.updateDataWithMessage(t.id,t,"start race driver id"))}updateMinStintMinute(e){let t=this.raceConfig();t&&(t.minStintMinute=e,this.updateDataWithMessage(t.id,t,"min stint minute"))}updateEndRaceButtonThresholdSeconds(e){let t=this.raceConfig();t&&(t.endRaceButtonThresholdSeconds=e,this.updateDataWithMessage(t.id,t,"end race button threshold seconds"))}updateDurationHour(e){let t=this.raceConfig();t&&(t.durationHour=e,this.updateDataWithMessage(t.id,t,"duration hour"))}getAll(){return u(this.collectionRef).pipe(f(this.destroyed),c(e=>e.map(t=>t).filter(t=>!t.deleted)))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var ne=Math.pow(10,8)*24*60*60*1e3,ft=-ne,ut=6048e5,bt=864e5,ht=6e4,J=36e5;var se=3600;var X=se*24,gt=X*7,pe=X*365.2425,ce=pe/12,vt=ce*3,z=Symbol.for("constructDateFrom");function x(i,e){return typeof i=="function"?i(e):i&&typeof i=="object"&&z in i?i[z](e):i instanceof Date?new i.constructor(e):new Date(e)}function _(i,e){return x(e||i,i)}function ee(i,e,t){return x(t?.in||i,+_(i)+e)}function te(i,e,t){return ee(i,e*J,t)}var W=class i extends m{collectionPath="/race-updates";collectionRef=b(this.firestore,this.collectionPath);raceUpdate=r(void 0);constructor(){super(),this.getAll().pipe(n()).subscribe(e=>{if(e.length>0){let t=e.at(0);if(t){let o=this.raceUpdate();(!o||o.updatedAt<t.updatedAt)&&this.raceUpdate.set(t)}}})}getAll(){return u(this.collectionRef).pipe(f(this.destroyed),c(e=>e.map(t=>t).filter(t=>!t.deleted)))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var S=class i{path="/race-management";httpClient=s(L);raceConfigService=s(M);raceUpdateService=s(W);activeRace=r(void 0);willEndRaceDate=r(void 0);constructor(){this.getActiveRace().pipe(n(),Z(1)).subscribe(e=>{e&&this.activeRace.set(e)}),d({race:this.getActiveRace(),raceFromUpdate:l(this.raceUpdateService.raceUpdate).pipe(y(e=>e?this.getRace(e.raceId):j(void 0)))}).pipe(n()).subscribe(({race:e,raceFromUpdate:t})=>{this.activeRace.set(t||e||void 0)}),d({race:this.getActiveRace(),raceFromUpdate:l(this.raceUpdateService.raceUpdate).pipe(y(e=>e?this.getRace(e.raceId):j(void 0)))}).pipe(n()).subscribe(({race:e,raceFromUpdate:t})=>{this.activeRace.set(t||e||void 0)}),d({activeRace:l(this.activeRace),raceConfig:l(this.raceConfigService.raceConfig)}).pipe(n(),c(({activeRace:e,raceConfig:t})=>this.getWillEndRaceDate(e,t))).subscribe(e=>{this.willEndRaceDate.set(e)})}getWillEndRaceDate(e,t){if(!(e===void 0||t===void 0))return e.endedAt?e.endedAt:te(e.startedAt,t.durationHour)}getActiveRace(){return this.httpClient.get(`${h.baseUrl}${this.path}/active-race`).pipe(c(e=>V(e)))}getRace(e){return this.httpClient.get(`${h.baseUrl}${this.path}/races/${e}`).pipe(c(t=>V(t)))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var k=class i extends m{collectionPath="/lap-updates";collectionRef=b(this.firestore,this.collectionPath);raceService=s(S);lapUpdate=r(void 0);constructor(){super(),d({lapUpdate:this.getLapUpdate()}).pipe(n()).subscribe(({lapUpdate:e})=>{if(e){let t=this.lapUpdate();(!t||t.updatedAt<e.updatedAt)&&this.lapUpdate.set(e)}})}getLapUpdate(){return d({lapUpdates:u(this.collectionRef),activeRace:l(this.raceService.activeRace)}).pipe(f(this.destroyed),c(({lapUpdates:e,activeRace:t})=>{let o=e;if(t&&o.length>0)return o.filter(a=>!a.deleted&&a.raceId===t.id).at(0)}))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};function ie(i){return{laps:T(i.laps),totalPages:i.totalPages,totalElements:i.totalElements}}var N=class i extends m{collectionPath="/lap-loading-configs";collectionRef=b(this.firestore,this.collectionPath);lapLoadingConfig=r(void 0);constructor(){super(),this.getAll().pipe(n()).subscribe(e=>{e.length>0&&this.lapLoadingConfig.set(e.at(0))})}updatePageSize(e){let t=this.lapLoadingConfig();t&&(t.pageSize=e,this.updateDataWithMessage(t.id,t,"page size"))}getAll(){return u(this.collectionRef).pipe(f(this.destroyed),c(e=>e.map(t=>t).filter(t=>!t.deleted)))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var P=class i extends m{collectionPath="/lap-refresh-updates";collectionRef=b(this.firestore,this.collectionPath);raceService=s(S);lapRefreshUpdate=r(void 0);constructor(){super(),d({lapRefreshUpdate:this.getLapRefreshUpdate()}).pipe(n()).subscribe(({lapRefreshUpdate:e})=>{if(e){let t=this.lapRefreshUpdate();(!t||t.updatedAt<e.updatedAt)&&this.lapRefreshUpdate.set(e)}})}updateRefresh(){let e=this.lapRefreshUpdate(),t=this.raceService.activeRace();!e&&t&&(e={deleted:!1,id:t.id,raceId:t.id,updatedAt:B.now()}),e&&(e.updatedAt=B.now(),e.deleted=!1,this.updateDataWithMessage(e.id,e,"lap refresh"))}getLapRefreshUpdate(){return d({lapRefreshUpdates:u(this.collectionRef),activeRace:l(this.raceService.activeRace)}).pipe(f(this.destroyed),c(({lapRefreshUpdates:e,activeRace:t})=>{let o=e;if(t&&o.length>0)return o.filter(a=>!a.deleted&&a.raceId===t.id).at(0)}))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var A=class i{path="/lap-management";httpClient=s(L);lapUpdateService=s(k);lapLoadingConfigService=s(N);lapRefreshUpdateService=s(P);raceService=s(S);notificationService=s(R);laps=r([]);lapsMapById=r(new Map);constructor(){d({activeRace:l(this.raceService.activeRace),lapLoadingConfig:l(this.lapLoadingConfigService.lapLoadingConfig)}).pipe(n(),y(({activeRace:e,lapLoadingConfig:t})=>e&&t?this.loadAllLapsPaged(e.id,[...this.laps().keys()],t.pageSize):[])).subscribe(e=>{this.laps.set(this.merge(this.laps(),e)),this.lapsMapById.set(new Map(this.laps().map(t=>[t.id,t])))}),l(this.lapUpdateService.lapUpdate).pipe(y(e=>e?this.getLaps(e.raceId,e.updatedIds):[]),n()).subscribe(e=>{this.laps.set(this.merge(this.laps(),e)),this.lapsMapById.set(new Map(this.laps().map(t=>[t.id,t])))}),d({lapRefreshUpdate:l(this.lapRefreshUpdateService.lapRefreshUpdate)}).pipe(n()).subscribe(e=>{e&&this.refreshLaps()})}refreshLaps(){let e=this.raceService.activeRace(),t=this.lapLoadingConfigService.lapLoadingConfig();if(e===void 0){this.notificationService.info("No active race");return}if(t){let o=[...this.lapsMapById().keys()];this.loadAllLapsPaged(e.id,o,t.pageSize).subscribe(a=>{this.laps.set(this.merge(this.laps(),a)),this.lapsMapById.set(new Map(this.laps().map(v=>[v.id,v]))),this.notificationService.success("Laps refreshed")})}}reloadAllLaps(){let e=this.raceService.activeRace(),t=this.lapLoadingConfigService.lapLoadingConfig();if(e===void 0){this.notificationService.info("No active race");return}t&&this.loadAllLapsPaged(e.id,[],t.pageSize).subscribe(o=>{this.laps.set(this.merge(this.laps(),o)),this.lapsMapById.set(new Map(this.laps().map(a=>[a.id,a]))),this.notificationService.success("Laps refreshed")})}merge(e,t){let o=new Map(e.map(a=>[a.id,a]));return t.forEach(a=>{o.set(a.id,a)}),Array.from(o.values()).sort((a,v)=>a.id-v.id)}loadAllLapsPaged(e,t,o){return new Y(a=>{let v=[],E=O=>{this.getLapsPaged(e,t,O,o).subscribe({next:I=>{v.push(...I.laps),O<I.totalPages-1?E(O+1):(a.next(v),a.complete())},error:I=>{a.error(I)}})};E(0)})}getLaps(e,t){return this.httpClient.post(`${h.baseUrl}${this.path}/laps`,{raceId:e,ids:t}).pipe(c(o=>T(o)))}getLapsPaged(e,t,o,a){return this.httpClient.post(`${h.baseUrl}${this.path}/laps-page`,{raceId:e,currentLapIds:t,pageNumber:o,pageSize:a}).pipe(c(v=>ie(v)))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var re=class i{lapDataService=s(A);lapConfigService=s(w);teamService=s(U);worker;cumulatedTimeByRaceNumber=r(new Map);pacesByRaceNumber=r(new Map);lastLapNumberByRaceNumber=r(new Map);validTeamPaceLaps=r([]);teamBestLap=r(void 0);lastTeamLap=r(void 0);lastTeamLapDeltaMilliseconds=r(void 0);pitLaps=r([]);constructor(){typeof Worker<"u"&&(this.worker=new Worker(new URL("worker-ENZWK5I5.js",import.meta.url),{type:"module"}),this.worker.onmessage=({data:e})=>{this.cumulatedTimeByRaceNumber.set(e.cumulatedTimeByRaceNumber),this.pacesByRaceNumber.set(e.pacesByRaceNumber),this.lastLapNumberByRaceNumber.set(e.lastLapNumberByRaceNumber),this.validTeamPaceLaps.set(e.validTeamPaceLaps),this.teamBestLap.set(e.teamBestLap),this.lastTeamLap.set(e.lastTeamLap),this.lastTeamLapDeltaMilliseconds.set(e.lastTeamLapDeltaMilliseconds),this.pitLaps.set(e.pitLaps)}),d({laps:l(this.lapDataService.lapsMapById),lapConfig:l(this.lapConfigService.lapConfig),activeTeam:l(this.teamService.activeTeam)}).pipe(n()).subscribe(({laps:e,lapConfig:t,activeTeam:o})=>{this.worker&&t&&this.worker.postMessage({laps:e,lapConfig:t,activeTeam:o})})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};export{m as a,w as b,M as c,ut as d,bt as e,ht as f,J as g,x as h,_ as i,ee as j,te as k,S as l,N as m,P as n,A as o,C as p,U as q,re as r};
