addEventListener("message",({data:n})=>{let u=n.cumulatedTimeByRaceNumber,e=n.pacesByRaceNumber,r=n.lastLapNumberByRaceNumber,t=n.lapSimulatorConfig,m=n.firstTeamRaceNumber,o=t.referenceRaceNumber,a=t.nextPitMilliseconds,c=t.timeLostThroughPitMilliseconds,i=w(u,o),s=k(u,i),b=P(s,i,o,r),l=T(u,e,r,i,t),f=R(l,a,c),p=v(m,u,r,e);postMessage({normalizedCumulatedTimeLaps:s,shadowLaps:b,futureLaps:l,futureLapsWithPitNow:f,virtualLastCumulatedTimeByRaceNumber:p})});function T(n,u,e,r,t){let m=[],o=new Map,a=n;for(let c=0;c<=t.simulatedLaps-1;c++){let i=[...n.keys()],s=C(a),b=N(s,u),l=M(s),f=M(b);i.forEach(p=>{let L=b.get(p);if(L)if(a.get(p)?.push(L),o.has(p))o.get(p)?.push(L);else{let h=[],d=s.get(p);d&&h.push(d),h.push(L),o.set(p,h)}})}return o.forEach((c,i)=>{let s=e.get(i);if(s){let b=s,l=g(c,r,b);m.push({startLapNumber:b,cumulatedTimeLaps:new Map([[i,l]])})}}),m}function C(n){let u=new Map;return n.forEach((e,r)=>{u.set(r,e[e.length-1])}),u}function M(n){let u=new Map,e=[];return n.forEach((r,t)=>{e.push({raceNumber:t,totalLapTimeMilliseconds:r})}),e.sort((r,t)=>t.totalLapTimeMilliseconds-r.totalLapTimeMilliseconds),e.forEach((r,t)=>{u.set(r.raceNumber,t+1)}),u}function N(n,u){let e=new Map;return n.forEach((r,t)=>{let m=u.get(t)||0;e.set(t,r+m)}),e}function w(n,u){if(n.has(u)){let e=n.get(u);return e&&e.length>0?e[e.length-1]/(e.length-1):0}return 0}function g(n,u,e){return u===0?n:n.map((r,t)=>(e+t)*u-r)}function k(n,u){if(u===0)return n;let e=new Map;return n.forEach((r,t)=>{let m=g(r,u,0);e.set(t,m)}),e}function P(n,u,e,r){let t=[],m=r.get(e);return m&&n.forEach((o,a)=>{if(e!==a){let c=r.get(a);if(c&&c!==m){let i=m-c,s=E(o,u,i);t.push({cumulatedTimeLaps:new Map([[a,s]]),startLapNumber:i>=0?i:0})}}}),t}function E(n,u,e){let r=[];return e<0&&(n=n.slice(Math.abs(e))),n.forEach(t=>{r.push(t+u*e)}),r}function R(n,u,e){let r=[];return n.forEach(t=>{let m=t.startLapNumber,o=new Map;t.cumulatedTimeLaps.forEach((a,c)=>{let i=[];for(let s=0;s<a.length;s++)s===0?i.push(a[s]):i.push(a[s]-(u+e));o.set(c,i)}),r.push({startLapNumber:m,cumulatedTimeLaps:o})}),r}function v(n,u,e,r){let t=new Map;if(!n)return t;let m=e.get(n);for(let[o,a]of u)if(o===n)a.length>0&&t.set(o,a[a.length-1]);else{let c=e.get(o);if(c===m)a.length>0&&t.set(o,a[a.length-1]);else{let i=r.get(o);if(i&&m&&c){let s=m-c;if(s>0&&a.length>0){let b=s*i,f=(a[a.length-1]||0)+b;t.set(o,f)}}}}return t}
